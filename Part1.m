clear all
clc
figure(1)
clf
axis([0 100 0 100])
dx=[];
dy=[];
d=[];
while 1
    title('Draw cubic Bezier curves using de Boor control points')
    xlabel('Left-click to add a point. Press ESC to quit.')
    [nx,ny,butt]=ginput(1); % Create an (xh,y) pair using the mouse input.
    if (butt==27)
        if (~isempty(d))
            disp('D = ')
            disp(d)
        end
        return
    end
    dx=[dx;nx]; % Add the new x to the history of all x.
    dy=[dy;ny]; % "   "   "   y   "   "   "   "   "   y.
    d=[dx dy]; % Create a 2xN matrix with the whole history of (x,y) pairs.
    %disp([nx ny]) % <-- Print (x,y) history to console.
    hold off
    plot(d(:,1),d(:,2),'ok') 
    axis([0 100 0 100])
    hold on
    N=length(dx);

    switch (N)
      case {0,1,2,3}
%        disp('MOAR DOTS')
      case 4,
        b0(1,:) = d(1,:);
        b1(1,:) = d(2,:);
        b2(1,:) = d(3,:);
        b3(1,:) = d(4,:);

      case 5,
%        disp('N=5')
        b0(1,:) = d(0+1,:);
        b1(1,:) = d(1+1,:);
        b2(1,:) = (1/2)*d(1+1,:)+(1/2)*d(2+1,:);
        b3(1,:) = (1/4)*d(1+1,:)+(1/2)*d(2+1,:)+(1/4)*d(3+1,:);
        
        b0(2,:) = (1/4)*d(1+1,:)+(1/2)*d(2+1,:)+(1/4)*d(3+1,:);
        b1(2,:) = (1/2)*d(2+1,:)+(1/2)*d(3+1,:);
        b2(2,:) = d(3+1,:);
        b3(2,:) = d(4+1,:);
      case 6,
%        disp('N=6')
        b0(1,:) = d(0+1,:);
        b1(1,:) = d(1+1,:);
        b2(1,:) = (1/2)*d(1+1,:)+(1/2)*d(2+1,:);
        b3(1,:) = (1/4)*d(1+1,:)+(7/12)*d(2+1,:)+(1/6)*d(3+1,:);
        
        b0(2,:) = (1/4)*d(1+1,:)+(7/12)*d(2+1,:)+(1/6)*d(3+1,:);
        b1(2,:) = (2/3)*d(2+1,:)+(1/3)*d(3+1,:);
        b2(2,:) = (1/3)*d(2+1,:)+(2/3)*d(3+1,:);
        b3(2,:) = (1/6)*d(2+1,:)+(7/12)*d(3+1,:)+(1/4)*d(4+1,:);

        b0(3,:) = (1/6)*d(2+1,:)+(7/12)*d(3+1,:)+(1/4)*d(4+1,:);
        b1(3,:) = (1/2)*d(3+1,:)+(1/2)*d(4+1,:);
        b2(3,:) = d(4+1,:);
        b3(3,:) = d(5+1,:);
      otherwise,
        b0(1,:) = d(0+1,:);
        b1(1,:) = d(1+1,:);
        b2(1,:) = (1/2)*d(1+1,:)+(1/2)*d(2+1,:);
        b3(1,:) = (1/4)*d(1+1,:)+(7/12)*d(2+1,:)+(1/6)*d(3+1,:);
        
        b0(2,:) = (1/4)*d(1+1,:)+(7/12)*d(2+1,:)+(1/6)*d(3+1,:);
        b1(2,:) = (2/3)*d(2+1,:)+(1/3)*d(3+1,:);
        b2(2,:) = (1/3)*d(2+1,:)+(2/3)*d(3+1,:);
        b3(2,:) = (1/6)*d(2+1,:)+(4/6)*d(3+1,:)+(1/6)*d(4+1,:);
        
        b0(3:N-5,:) = (1/6)*d(2+1:N-5,:)+(4/6)*d(3+1:N-4,:)+(1/6)*d(4+1:N-3,:);
        b1(3:N-5,:) = (2/3)*d(3+1:N-4,:)+(1/3)*d(4+1:N-3,:);
        b2(3:N-5,:) = (1/3)*d(3+1:N-4,:)+(2/3)*d(4+1:N-3,:);
        b3(3:N-5,:) = (1/6)*d(3+1:N-4,:)+(4/6)*d(4+1:N-3,:)+(1/6)*d(5+1:N-2,:);
        
        b0(N-4,:) = (1/6)*d(N-4,:)+(4/6)*d(N-3,:)+(1/6)*d(N-2,:);
        b1(N-4,:) = (2/3)*d(N-3,:)+(1/3)*d(N-2,:);
        b2(N-4,:) = (1/3)*d(N-3,:)+(2/3)*d(N-2,:);
        b3(N-4,:) = (1/6)*d(N-3,:)+(7/12)*d(N-2,:)+(1/4)*d(N-1,:);
        
        b0(N-3,:) = (1/6)*d(N-3,:)+(7/12)*d(N-2,:)+(1/4)*d(N-1,:);
        b1(N-3,:) = (1/2)*d(N-2,:)+(1/2)*d(N-1,:);
        b2(N-3,:) = d(N-1,:);
        b3(N-3,:) = d(N,:);
        
    end
    if (N>=4)
        plot(b0(:,1),b0(:,2),'b.')
        plot(b1(:,1),b1(:,2),'r.')
        plot(b2(:,1),b2(:,2),'r.')
        plot(b3(:,1),b3(:,2),'bo')

        clear b10 b11 b12 b20 b21 b30
        [Nindex,other]=size(b0);
        t=0:0.05:1;
        for j=1:Nindex

            b10(j,:,1) =  b0(j,1)*(1-t) +  b1(j,1)*t;
            b10(j,:,2) =  b0(j,2)*(1-t) +  b1(j,2)*t;
            b11(j,:,1) =  b1(j,1)*(1-t) +  b2(j,1)*t;
            b11(j,:,2) =  b1(j,2)*(1-t) +  b2(j,2)*t;
            b12(j,:,1) =  b2(j,1)*(1-t) +  b3(j,1)*t;
            b12(j,:,2) =  b2(j,2)*(1-t) +  b3(j,2)*t;
            
            b20(j,:,1) = b10(j,:,1).*(1-t) + b11(j,:,1).*t;
            b20(j,:,2) = b10(j,:,2).*(1-t) + b11(j,:,2).*t;
            b21(j,:,1) = b11(j,:,1).*(1-t) + b12(j,:,1).*t;
            b21(j,:,2) = b11(j,:,2).*(1-t) + b12(j,:,2).*t;
            
            b30(j,:,1) = b20(j,:,1).*(1-t) + b21(j,:,1).*t;
            b30(j,:,2) = b20(j,:,2).*(1-t) + b21(j,:,2).*t;

            plot(b30(j,:,1),b30(j,:,2),'-g');
            plot(b30(j,:,1),b30(j,:,2),'.m','MarkerSize',4);
        end
    end

end